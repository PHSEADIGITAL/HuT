<%- include("partials/header", { title: "Marketplace" }) %>

<section class="hero small">
  <h1>Bonny Island Marketplace</h1>
  <p>Buy and sell second-hand items. Base plan includes 4 listings monthly, with paid upgrades available.</p>
</section>

<section class="card">
  <div class="marketplace-actions">
    <form class="marketplace-filter-form" method="GET" action="/marketplace">
      <div class="marketplace-filter-field">
        <label for="q">Search</label>
        <input id="q" name="q" value="<%= filters.q %>" placeholder="Phone, furniture, electronics..." />
      </div>
      <div class="marketplace-filter-field">
        <label for="category">Category</label>
        <select id="category" name="category">
          <option value="">All categories</option>
          <% categories.forEach((category) => { %>
            <option value="<%= category %>" <%= filters.category === category ? "selected" : "" %>><%= category %></option>
          <% }) %>
        </select>
      </div>
      <div class="marketplace-filter-field">
        <label for="condition">Condition</label>
        <select id="condition" name="condition">
          <option value="">All</option>
          <% conditions.forEach((item) => { %>
            <option value="<%= item %>" <%= filters.condition === item ? "selected" : "" %>><%= item %></option>
          <% }) %>
        </select>
      </div>
      <div class="marketplace-filter-field">
        <label for="minPrice">Min price</label>
        <input id="minPrice" name="minPrice" type="number" min="0" value="<%= filters.minPrice %>" />
      </div>
      <div class="marketplace-filter-field">
        <label for="maxPrice">Max price</label>
        <input id="maxPrice" name="maxPrice" type="number" min="0" value="<%= filters.maxPrice %>" />
      </div>
      <div class="marketplace-filter-field">
        <label for="sort">Sort</label>
        <select id="sort" name="sort">
          <option value="newest" <%= filters.sort === "newest" ? "selected" : "" %>>Newest</option>
          <option value="price_asc" <%= filters.sort === "price_asc" ? "selected" : "" %>>Price low-high</option>
          <option value="price_desc" <%= filters.sort === "price_desc" ? "selected" : "" %>>Price high-low</option>
        </select>
      </div>
      <div class="marketplace-filter-field">
        <button type="submit">Apply filters</button>
      </div>
    </form>

    <div class="marketplace-cta">
      <% if (currentUser) { %>
        <a class="button-link" href="/marketplace/new">Create listing</a>
        <a class="ghost-link" href="/marketplace/my-listings">My listings</a>
        <a class="ghost-link" href="/wallet">Wallet (<%= formatNaira(walletBalance || 0) %>)</a>
      <% } else { %>
        <a class="button-link" href="/auth/login?next=%2Fmarketplace">Sign in to sell</a>
      <% } %>
    </div>
  </div>
</section>

<% if (currentUser && limitState) { %>
  <section class="card">
    <h3>Your listing allowance this month</h3>
    <p class="muted">
      Used <strong><%= limitState.used %></strong> of <strong><%= limitState.includedLimit %></strong>
      listings (base 4 + <%= limitState.extraListings %> from plans).
    </p>
    <% if (activePlanSubscriptions.length) { %>
      <p class="muted tiny">
        Active plans:
        <%= activePlanSubscriptions.map((item) => item.planName).join(", ") %>
      </p>
    <% } %>
    <div class="marketplace-plan-grid">
      <% marketplacePlans.forEach((plan) => { %>
        <article class="card">
          <h4><%= plan.name %></h4>
          <p class="market-price"><%= formatNaira(plan.amount) %></p>
          <p class="muted tiny"><%= plan.description %></p>
          <p class="muted tiny">Adds <%= plan.extraListings %> listings/month</p>
          <form method="POST" action="/marketplace/plans/purchase">
            <input type="hidden" name="planId" value="<%= plan.id %>" />
            <button type="submit" class="ghost-btn">Buy with wallet</button>
          </form>
        </article>
      <% }) %>
    </div>
  </section>
<% } %>

<section class="marketplace-grid">
  <% if (!listings.length) { %>
    <article class="card">
      <h3>No items found.</h3>
      <p class="muted">Try adjusting your filter settings.</p>
    </article>
  <% } %>
  <% listings.forEach((listing) => { %>
    <article class="card market-item-card">
      <a href="/marketplace/listings/<%= listing.id %>">
        <img src="<%= listing.primaryImage %>" alt="<%= listing.title %>" class="market-item-image" />
      </a>
      <div class="market-item-body">
        <h3><a href="/marketplace/listings/<%= listing.id %>"><%= listing.title %></a></h3>
        <p class="muted"><%= listing.category %> • <%= listing.condition %></p>
        <p class="market-price"><%= formatNaira(listing.price) %></p>
        <p class="muted tiny">Seller: <%= listing.sellerName %> • Contact hidden until unlock (<%= formatNaira(contactUnlockFeeNaira) %>)</p>
      </div>
    </article>
  <% }) %>
</section>

<%- include("partials/footer", { platform }) %>
