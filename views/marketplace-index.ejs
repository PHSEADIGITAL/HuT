<%- include("partials/header", { title: "Marketplace" }) %>
<%- include("partials/marketplace-masthead", {
  categories,
  searchQuery: filters.q,
  searchCategory: filters.category,
  searchLocation: filters.location,
  searchNeighborhood: filters.neighborhood
}) %>

<section class="marketplace-ebay-layout">
  <aside class="card marketplace-filter-sidebar">
    <h3>Filter results</h3>
    <form class="marketplace-filter-stack" method="GET" action="/marketplace">
      <input type="hidden" name="q" value="<%= filters.q %>" />
      <div class="marketplace-filter-field">
        <label for="category">Category</label>
        <select id="category" name="category">
          <option value="">All categories</option>
          <% categories.forEach((category) => { %>
            <option value="<%= category %>" <%= filters.category === category ? "selected" : "" %>>
              <%= category %>
            </option>
          <% }) %>
        </select>
      </div>
      <div class="marketplace-filter-field">
        <label for="condition">Condition</label>
        <select id="condition" name="condition">
          <option value="">All conditions</option>
          <% conditions.forEach((item) => { %>
            <option value="<%= item %>" <%= filters.condition === item ? "selected" : "" %>><%= item %></option>
          <% }) %>
        </select>
      </div>
      <div class="marketplace-filter-field">
        <label for="location">Location</label>
        <select id="location" name="location">
          <option value="">All locations</option>
          <% locationOptions.forEach((item) => { %>
            <option value="<%= item %>" <%= filters.location === item ? "selected" : "" %>><%= item %></option>
          <% }) %>
        </select>
      </div>
      <div class="marketplace-filter-field">
        <label for="neighborhood">Neighborhood</label>
        <select id="neighborhood" name="neighborhood">
          <option value="">All neighborhoods</option>
          <% neighborhoodOptions.forEach((item) => { %>
            <option value="<%= item %>" <%= filters.neighborhood === item ? "selected" : "" %>><%= item %></option>
          <% }) %>
        </select>
      </div>
      <div class="marketplace-filter-field">
        <label for="minPrice">Min price</label>
        <input id="minPrice" name="minPrice" type="number" min="0" value="<%= filters.minPrice %>" />
      </div>
      <div class="marketplace-filter-field">
        <label for="maxPrice">Max price</label>
        <input id="maxPrice" name="maxPrice" type="number" min="0" value="<%= filters.maxPrice %>" />
      </div>
      <div class="marketplace-filter-field">
        <label for="sort">Sort</label>
        <select id="sort" name="sort">
          <option value="newest" <%= filters.sort === "newest" ? "selected" : "" %>>Best Match / Newest</option>
          <option value="price_asc" <%= filters.sort === "price_asc" ? "selected" : "" %>>Price + Shipping: lowest first</option>
          <option value="price_desc" <%= filters.sort === "price_desc" ? "selected" : "" %>>Price + Shipping: highest first</option>
        </select>
      </div>
      <div class="marketplace-filter-field">
        <button type="submit">Apply</button>
      </div>
    </form>

    <hr />

    <h3>Shop by category</h3>
    <ul class="marketplace-category-list">
      <% categoryCards.forEach((categoryCard) => { %>
        <li>
          <a class="<%= categoryCard.active ? 'active' : '' %>" href="<%= categoryCard.href %>">
            <span><%= categoryCard.name %></span>
            <small><%= categoryCard.listingCount %></small>
          </a>
        </li>
      <% }) %>
    </ul>
  </aside>

  <section class="marketplace-results-panel">
    <article class="card marketplace-results-meta">
      <div>
        <h1>Bonny Island Marketplace</h1>
        <p class="muted">
          <strong><%= listings.length %></strong> item<%= listings.length === 1 ? "" : "s" %>
          found.
        </p>
        <% if (currentUser) { %>
          <p class="muted tiny">
            Points: <strong><%= marketplacePoints || 0 %></strong> • Paid unlocks:
            <strong><%= marketplacePaidUnlockCount || 0 %></strong> • 5 points unlocks 1 seller contact.
          </p>
        <% } %>
      </div>
      <div class="marketplace-cta">
        <% if (currentUser) { %>
          <a class="button-link" href="/marketplace/new">Sell an item</a>
          <a class="ghost-link" href="/marketplace/my-listings">My listings</a>
          <a class="ghost-link" href="/wallet">Wallet (<%= formatNaira(walletBalance || 0) %>)</a>
        <% } else { %>
          <a class="button-link" href="/auth/login?next=%2Fmarketplace">Sign in to sell</a>
        <% } %>
      </div>
    </article>

    <% if (!currentUser) { %>
      <article class="card">
        <h3>Sign in from marketplace</h3>
        <p class="muted tiny">Authenticate here to buy, unlock contacts, and sell items.</p>
        <form class="grid-form compact" method="POST" action="/auth/login" data-remember-form="login">
          <input type="hidden" name="next" value="/marketplace" />
          <div>
            <label for="marketLoginEmail">Email</label>
            <input id="marketLoginEmail" name="email" type="email" required autocomplete="email" />
          </div>
          <div>
            <label for="marketLoginPassword">Password</label>
            <input
              id="marketLoginPassword"
              name="password"
              type="password"
              required
              autocomplete="current-password"
            />
          </div>
          <div class="full">
            <label class="checkbox">
              <input type="checkbox" name="rememberCredentials" value="yes" data-remember-checkbox />
              Save login credentials on this device for autofill
            </label>
          </div>
          <div class="full">
            <button type="submit">Sign in</button>
          </div>
        </form>
      </article>
    <% } %>

    <article class="card marketplace-category-strip-card">
      <div class="marketplace-category-strip">
        <% categoryCards.forEach((categoryCard) => { %>
          <a class="marketplace-strip-item <%= categoryCard.active ? 'active' : '' %>" href="<%= categoryCard.href %>">
            <img src="<%= categoryCard.imageUrl %>" alt="<%= categoryCard.name %> category" />
            <span><%= categoryCard.name %></span>
          </a>
        <% }) %>
      </div>
    </article>

    <% if (currentUser && limitState) { %>
      <article class="card">
        <h3>Your listing allowance this month</h3>
        <p class="muted">
          Used <strong><%= limitState.used %></strong> of <strong><%= limitState.includedLimit %></strong>
          listings (base 4 + <%= limitState.extraListings %> from plans).
        </p>
        <% if (activePlanSubscriptions.length) { %>
          <p class="muted tiny">
            Active plans:
            <%= activePlanSubscriptions.map((item) => item.planName).join(", ") %>
          </p>
        <% } %>
        <div class="marketplace-plan-grid">
          <% marketplacePlans.forEach((plan) => { %>
            <article class="card">
              <h4><%= plan.name %></h4>
              <p class="market-price"><%= formatNaira(plan.amount) %></p>
              <p class="muted tiny"><%= plan.description %></p>
              <p class="muted tiny">Adds <%= plan.extraListings %> listings/month</p>
              <form method="POST" action="/marketplace/plans/purchase">
                <input type="hidden" name="planId" value="<%= plan.id %>" />
                <button type="submit" class="ghost-btn">Buy with wallet</button>
              </form>
            </article>
          <% }) %>
        </div>
      </article>
    <% } %>

    <section class="marketplace-result-list">
      <% if (!listings.length) { %>
        <article class="card">
          <h3>No items found</h3>
          <p class="muted">Try adjusting category, condition, or price filters.</p>
        </article>
      <% } %>
      <% listings.forEach((listing) => { %>
        <article class="market-result-card">
          <a class="market-result-media" href="/marketplace/listings/<%= listing.id %>">
            <img src="<%= listing.primaryImage %>" alt="<%= listing.title %>" />
          </a>
          <div class="market-result-main">
            <h3><a href="/marketplace/listings/<%= listing.id %>"><%= listing.title %></a></h3>
            <p class="muted tiny"><%= listing.category %> • <%= listing.condition %></p>
            <p class="muted tiny">
              <%= listing.location || "Location not set" %>
              <% if (listing.neighborhood) { %>• <%= listing.neighborhood %><% } %>
            </p>
            <p class="muted tiny">
              Seller:
              <a href="/marketplace/sellers/<%= listing.sellerUserId %>"><%= listing.sellerName %></a>
              • Rating:
              <%= listing.sellerRatingCount ? `${listing.sellerRatingAverage}/5 (${listing.sellerRatingCount})` : "No ratings yet" %>
            </p>
            <p class="muted tiny">
              Contact unlock fee: <%= formatNaira(contactUnlockFeeNaira) %> • Bonny Island pickup
            </p>
          </div>
          <div class="market-result-side">
            <p class="market-price"><%= formatNaira(listing.price) %></p>
            <a class="button-link small full-width" href="/marketplace/listings/<%= listing.id %>">View item</a>
          </div>
        </article>
      <% }) %>
    </section>
  </section>
</section>

<script>
  (function attachMarketplaceNeighborhoodFilter() {
    const locationSelect = document.getElementById("location");
    const neighborhoodSelect = document.getElementById("neighborhood");
    const locationMap = <%- JSON.stringify(locationNeighborhoods || {}) %>;
    if (!locationSelect || !neighborhoodSelect || !locationMap) {
      return;
    }

    const currentNeighborhood = neighborhoodSelect.value;
    function rebuildNeighborhoodOptions() {
      const selectedLocation = locationSelect.value;
      const options = selectedLocation
        ? (locationMap[selectedLocation] || [])
        : Object.values(locationMap).flat();
      const unique = Array.from(new Set(options));
      const previousValue = neighborhoodSelect.value || currentNeighborhood || "";
      neighborhoodSelect.innerHTML = '<option value="">All neighborhoods</option>';
      unique.forEach((item) => {
        const option = document.createElement("option");
        option.value = item;
        option.textContent = item;
        if (item === previousValue) {
          option.selected = true;
        }
        neighborhoodSelect.appendChild(option);
      });
    }

    locationSelect.addEventListener("change", rebuildNeighborhoodOptions);
  })();
</script>

<%- include("partials/footer", { platform }) %>
