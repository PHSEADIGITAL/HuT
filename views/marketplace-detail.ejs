<%- include("partials/header", { title: listing.title }) %>
<%- include("partials/marketplace-masthead", {
  categories,
  searchQuery: "",
  searchCategory: listing.category,
  searchLocation: listing.location || "",
  searchNeighborhood: listing.neighborhood || ""
}) %>

<section class="card marketplace-page-intro">
  <h1><%= listing.title %></h1>
  <p class="muted">
    <%= listing.category %> • <%= listing.condition %> •
    <%= listing.location || "Location not set" %>
    <% if (listing.neighborhood) { %>• <%= listing.neighborhood %><% } %>
    • Listed <%= listing.createdAt %>
  </p>
</section>

<section class="marketplace-detail-layout marketplace-detail-shell">
  <article class="card">
    <img src="<%= listing.primaryImage %>" alt="<%= listing.title %>" class="market-detail-image" />
    <% if (Array.isArray(listing.imageUrls) && listing.imageUrls.length > 1) { %>
      <div class="gallery-strip">
        <% listing.imageUrls.slice(0, 5).forEach((image, index) => { %>
          <img src="<%= image %>" alt="<%= listing.title %> image <%= index + 1 %>" />
        <% }) %>
      </div>
    <% } %>
    <h2>Item description</h2>
    <p><%= listing.description %></p>
  </article>

  <aside class="card marketplace-sticky-card">
    <h3>Item details</h3>
    <p class="price-anchor muted tiny">
      Anchor price: <span class="anchor-original"><%= formatNaira(calculateAnchoredPrice(listing.price, 0.14)) %></span>
    </p>
    <p class="market-price"><%= formatNaira(listing.price) %></p>
    <p class="muted tiny">Condition: <strong><%= listing.condition %></strong></p>
    <p class="muted tiny">
      Location:
      <strong><%= listing.location || "Location not set" %></strong>
      <% if (listing.neighborhood) { %>• <%= listing.neighborhood %><% } %>
    </p>
    <p class="muted tiny">
      Seller:
      <strong><a href="/marketplace/sellers/<%= listing.sellerUserId %>"><%= listing.sellerName %></a></strong>
      • Rating:
      <%= sellerRating.count ? `${sellerRating.average}/5 (${sellerRating.count})` : "No ratings yet" %>
    </p>
    <p class="muted tiny">
      Contact:
      <% if (canViewContact && seller) { %>
        <strong><%= seller.phone %></strong>
      <% } else { %>
        <strong><%= listing.sellerPhoneMasked %></strong>
      <% } %>
    </p>

    <% if (canUnlock) { %>
      <form method="POST" action="/marketplace/listings/<%= listing.id %>/unlock-contact">
        <button type="submit">Unlock seller contact for <%= formatNaira(contactUnlockFeeNaira) %></button>
      </form>
      <p class="muted tiny">
        Wallet balance: <%= formatNaira(walletBalance || 0) %> • Points: <%= marketplacePoints || 0 %> •
        <a href="/wallet">Fund wallet</a>
      </p>
    <% } %>

    <% if (!currentUser) { %>
      <a class="button-link full-width" href="/auth/login?next=<%= encodeURIComponent(`/marketplace/listings/${listing.id}`) %>">
        Sign in to unlock contact
      </a>
    <% } %>
  </aside>
</section>

<section class="card">
  <h3>Similar listings</h3>
  <section class="marketplace-result-list">
    <% if (!relatedListings.length) { %>
      <p class="muted">No similar listings yet.</p>
    <% } %>
    <% relatedListings.forEach((item) => { %>
      <article class="market-result-card">
        <a class="market-result-media" href="/marketplace/listings/<%= item.id %>">
          <img src="<%= item.primaryImage %>" alt="<%= item.title %>" />
        </a>
        <div class="market-result-main">
          <h3><a href="/marketplace/listings/<%= item.id %>"><%= item.title %></a></h3>
          <p class="muted tiny"><%= item.category %> • <%= item.condition %></p>
          <p class="muted tiny">
            <%= item.location || "Location not set" %>
            <% if (item.neighborhood) { %>• <%= item.neighborhood %><% } %>
          </p>
          <p class="muted tiny">Seller: <%= item.sellerName %></p>
        </div>
        <div class="market-result-side">
          <p class="price-anchor muted tiny">
            Anchor price: <span class="anchor-original"><%= formatNaira(calculateAnchoredPrice(item.price, 0.12)) %></span>
          </p>
          <p class="market-price"><%= formatNaira(item.price) %></p>
          <a class="button-link small full-width" href="/marketplace/listings/<%= item.id %>">View item</a>
        </div>
      </article>
    <% }) %>
  </section>
</section>

<%- include("partials/footer", { platform }) %>
