<%- include("partials/header", { title: `${hotel.name} Dashboard` }) %>

<section class="hero small">
  <h1><%= hotel.name %> - Admin Dashboard</h1>
  <p class="muted"><%= hotel.location %></p>
  <% if (hotel.address) { %>
    <p class="muted tiny"><%= hotel.address %></p>
  <% } %>
</section>

<section class="stats-grid">
  <article class="card">
    <h3>Gross Booking Sales</h3>
    <p class="metric"><%= formatNaira(grossSales) %></p>
  </article>
  <article class="card">
    <h3>Hotel Receivables</h3>
    <p class="metric"><%= formatNaira(hotelReceivables) %></p>
  </article>
  <article class="card">
    <h3>Platform Commission</h3>
    <p class="metric"><%= formatNaira(platformRevenue) %></p>
  </article>
  <article class="card">
    <h3>Commission Rate</h3>
    <p class="metric"><%= formatPercent(hotel.commissionRate) %></p>
  </article>
</section>

<section class="card">
  <h2>Commercial settings</h2>
  <p>
    Current commission rate:
    <strong><%= formatPercent(hotel.commissionRate || platform.defaultCommissionRate) %></strong>
  </p>
  <% if (currentUser && currentUser.role === "platform_admin") { %>
    <details class="inline-editor">
      <summary>Adjust commission rate</summary>
      <form class="commission-form" method="POST" action="/admin/hotels/<%= hotel.id %>/commission">
        <input type="hidden" name="returnTo" value="/admin/hotels/<%= hotel.id %>/dashboard" />
        <div>
          <label for="commissionRateInput">Commission (%)</label>
          <input
            id="commissionRateInput"
            name="commissionRate"
            type="number"
            min="5"
            max="30"
            step="0.1"
            value="<%= Number(((hotel.commissionRate || platform.defaultCommissionRate) * 100).toFixed(2)) %>"
            required
          />
        </div>
        <button type="submit">Update commission</button>
      </form>
    </details>
  <% } else { %>
    <p class="muted tiny">Only platform owner accounts can update commission rates.</p>
  <% } %>
</section>

<% if (currentUser && currentUser.role === "platform_admin") { %>
  <section class="card">
    <h2>Edit hotel profile</h2>
    <p class="muted tiny">Platform owners can edit all hotel profile fields after onboarding.</p>
    <details class="inline-editor">
      <summary>Edit all hotel areas</summary>
      <form class="grid-form" method="POST" action="/admin/hotels/<%= hotel.id %>/profile">
        <div>
          <label for="name">Hotel name</label>
          <input id="name" name="name" type="text" value="<%= hotel.name %>" required />
        </div>
        <div>
          <label for="location">Location</label>
          <input id="location" name="location" type="text" value="<%= hotel.location %>" required />
        </div>
        <div class="full">
          <label for="address">Address</label>
          <input id="address" name="address" type="text" value="<%= hotel.address || '' %>" required />
        </div>
        <div class="full">
          <label for="about">About section</label>
          <textarea id="about" name="about" rows="4" required><%= hotel.about || hotel.description || '' %></textarea>
        </div>
        <div>
          <label for="bankName">Bank name</label>
          <input id="bankName" name="bankName" type="text" value="<%= hotel.bankName %>" required />
        </div>
        <div>
          <label for="bankAccount">Bank account</label>
          <input id="bankAccount" name="bankAccount" type="text" value="<%= hotel.bankAccount %>" required />
        </div>
        <div>
          <label for="paystackSubaccountCode">Paystack subaccount code (optional)</label>
          <input
            id="paystackSubaccountCode"
            name="paystackSubaccountCode"
            type="text"
            value="<%= hotel.paystackSubaccountCode || '' %>"
            placeholder="ACCT_xxxxxxxxxxxxx"
          />
        </div>
        <div>
          <label for="flutterwaveSubaccountId">Flutterwave subaccount ID (optional)</label>
          <input
            id="flutterwaveSubaccountId"
            name="flutterwaveSubaccountId"
            type="text"
            value="<%= hotel.flutterwaveSubaccountId || '' %>"
            placeholder="FLWSECK-xxxxxxxxxxx-X"
          />
        </div>
        <div>
          <label for="cancellationPolicy">Cancellation policy</label>
          <select id="cancellationPolicy" name="cancellationPolicy">
            <option value="flexible" <%= hotel.cancellationPolicy === "flexible" ? "selected" : "" %>>Flexible</option>
            <option value="moderate" <%= hotel.cancellationPolicy === "moderate" ? "selected" : "" %>>Moderate</option>
            <option value="strict" <%= hotel.cancellationPolicy === "strict" ? "selected" : "" %>>Strict</option>
          </select>
        </div>
        <div>
          <label for="pickupFee">Pickup fee (NGN)</label>
          <input id="pickupFee" name="pickupFee" type="number" min="0" value="<%= hotel.pickupFee || 0 %>" />
        </div>
        <div>
          <label for="commissionRateEdit">Commission (%)</label>
          <input
            id="commissionRateEdit"
            name="commissionRate"
            type="number"
            min="5"
            max="30"
            step="0.1"
            value="<%= Number(((hotel.commissionRate || platform.defaultCommissionRate) * 100).toFixed(2)) %>"
            required
          />
        </div>
        <div class="full">
          <label for="coverImage">Cover image URL</label>
          <input id="coverImage" name="coverImage" type="url" value="<%= hotel.coverImage || '' %>" />
        </div>
        <div class="full">
          <label for="galleryImages">Gallery image URLs (comma-separated)</label>
          <textarea id="galleryImages" name="galleryImages" rows="2"><%= Array.isArray(hotel.galleryImages) ? hotel.galleryImages.join(", ") : (hotel.galleryImages || "") %></textarea>
        </div>
        <div class="full">
          <h3>Hotel amenities</h3>
          <div class="option-check-grid">
            <% amenityOptions.forEach((item) => { %>
              <label class="checkbox option-check-item">
                <input type="checkbox" name="amenities" value="<%= item %>" <%= (hotel.amenities || []).includes(item) ? "checked" : "" %> />
                <span><%= item %></span>
              </label>
            <% }) %>
          </div>
        </div>
        <div class="full">
          <h3>Room features</h3>
          <div class="option-check-grid">
            <% roomFeatureOptions.forEach((item) => { %>
              <label class="checkbox option-check-item">
                <input type="checkbox" name="roomFeatures" value="<%= item %>" <%= (selectedRoomFeatures || []).includes(item) ? "checked" : "" %> />
                <span><%= item %></span>
              </label>
            <% }) %>
          </div>
        </div>
        <div class="full">
          <label class="checkbox">
            <input type="checkbox" name="premiumListingActive" <%= hotel.premiumListingActive ? "checked" : "" %> />
            Premium listing active
          </label>
        </div>
        <div class="full">
          <button type="submit">Save hotel profile</button>
        </div>
      </form>
    </details>
  </section>
<% } %>

<section class="card">
  <h2>Premium listing subscription</h2>
  <p>
    Status:
    <strong><%= hotel.premiumListingActive ? "Active" : "Inactive" %></strong>
  </p>
  <p>Expires: <strong><%= hotel.premiumListingExpiresAt || "-" %></strong></p>
  <form method="POST" action="/admin/hotels/<%= hotel.id %>/subscription/renew">
    <button type="submit">Renew +30 days (<%= formatNaira(platform.premiumSubscriptionMonthlyFee) %>)</button>
  </form>
</section>

<section
  class="card"
  id="availability-root"
  data-hotel-id="<%= hotel.id %>"
  data-check-in="<%= checkInDate %>"
  data-check-out="<%= checkOutDate %>"
>
  <h2>Real-time room availability</h2>
  <form class="grid-form compact" method="GET" action="/admin/hotels/<%= hotel.id %>/dashboard">
    <div>
      <label for="checkInDate">Check-in</label>
      <input id="checkInDate" type="date" name="checkInDate" value="<%= checkInDate %>" required />
    </div>
    <div>
      <label for="checkOutDate">Check-out</label>
      <input id="checkOutDate" type="date" name="checkOutDate" value="<%= checkOutDate %>" required />
    </div>
    <div class="align-end">
      <button type="submit">Refresh</button>
    </div>
  </form>

  <div class="table-wrap">
    <table class="room-category-table">
      <thead>
        <tr>
          <th>Room</th>
          <th>Price / Night</th>
          <th>Total Units</th>
          <th>Booked</th>
          <th>Available</th>
          <th>Update Inventory + Price</th>
        </tr>
      </thead>
      <tbody>
        <% if (!availability.length) { %>
          <tr>
            <td colspan="6" class="muted">No room categories configured for this hotel yet.</td>
          </tr>
        <% } %>
        <% availability.forEach((room) => { %>
          <tr data-room-id="<%= room.roomId %>">
            <td><%= room.category %></td>
            <td><%= formatNaira(room.pricePerNight) %></td>
            <td><%= room.totalUnits %></td>
            <td class="booked-value"><%= room.activeBookings %></td>
            <td class="availability-value <%= room.soldOut ? 'danger' : 'success' %>">
              <%= room.availableUnits %>
            </td>
            <td>
              <details class="inline-editor compact">
                <summary>Adjust</summary>
                <form
                  class="room-update-form"
                  method="POST"
                  action="/admin/hotels/<%= hotel.id %>/rooms/<%= room.roomId %>"
                >
                  <div>
                    <label for="price-<%= room.roomId %>">Price (NGN)</label>
                    <input
                      id="price-<%= room.roomId %>"
                      type="number"
                      name="pricePerNight"
                      min="1000"
                      step="100"
                      value="<%= room.pricePerNight %>"
                      required
                    />
                  </div>
                  <div>
                    <label for="units-<%= room.roomId %>">Units</label>
                    <input
                      id="units-<%= room.roomId %>"
                      type="number"
                      name="totalUnits"
                      min="1"
                      step="1"
                      value="<%= room.totalUnits %>"
                      required
                    />
                  </div>
                  <button type="submit">Save</button>
                </form>
              </details>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Bookings (with days booked + emergency contact)</h2>
  <form class="grid-form compact" method="GET" action="/admin/hotels/<%= hotel.id %>/dashboard">
    <input type="hidden" name="checkInDate" value="<%= checkInDate %>" />
    <input type="hidden" name="checkOutDate" value="<%= checkOutDate %>" />
    <div>
      <label for="bookingReference">Booking reference lookup</label>
      <input
        id="bookingReference"
        name="bookingReference"
        type="text"
        value="<%= bookingReference || '' %>"
        placeholder="Booking reference or transaction reference"
      />
    </div>
    <div class="align-end">
      <button type="submit">Search booking</button>
    </div>
    <% if (bookingReference) { %>
      <div class="align-end">
        <a
          class="ghost-link"
          href="/admin/hotels/<%= hotel.id %>/dashboard?checkInDate=<%= checkInDate %>&checkOutDate=<%= checkOutDate %>"
        >
          Clear search
        </a>
      </div>
    <% } %>
  </form>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Created</th>
          <th>Reference</th>
          <th>Guest</th>
          <th>Stay</th>
          <th>Days Booked</th>
          <th>Emergency Contact</th>
          <th>Pickup</th>
          <th>Total Paid</th>
          <th>Fraud</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% if (!bookings.length) { %>
          <tr>
            <td colspan="10" class="muted">
              <%= bookingReference ? "No bookings matched that reference." : "No bookings yet." %>
            </td>
          </tr>
        <% } %>
        <% bookings.forEach((booking) => { %>
          <tr>
            <td><%= booking.createdAt %></td>
            <td><%= booking.referenceNumber %></td>
            <td>
              <strong><%= booking.customerName %></strong><br />
              <span class="muted"><%= booking.email %></span>
            </td>
            <td><%= booking.checkInDate %> to <%= booking.checkOutDate %></td>
            <td><%= booking.nights %></td>
            <td><%= booking.emergencyContactName %><br /><span class="muted"><%= booking.emergencyContactPhone %></span></td>
            <td><%= booking.pickupRequested ? "Yes" : "No" %></td>
            <td><%= formatNaira(booking.pricing.totalPaid) %></td>
            <td>
              <span class="badge <%= booking.fraudScore >= 40 ? 'warn' : 'ok' %>">
                <%= booking.fraudScore %>
              </span>
            </td>
            <td><%= booking.status %> / <%= booking.paymentStatus %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Payment ledger</h2>
  <p class="muted">Payments are split into hotel payout and HuT commission account.</p>
  <p><strong>Hotel Bank Account:</strong> <%= hotel.bankName %> - <%= hotel.bankAccount %></p>
  <p><strong>HuT Collection Channel:</strong> <%= platform.collectionAccountAlias || "HuT Business Collection Account" %></p>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Reference</th>
          <th>Provider</th>
          <th>Gross</th>
          <th>Hotel Payout</th>
          <th>Platform Earning</th>
        </tr>
      </thead>
      <tbody>
        <% if (!payments.length) { %>
          <tr>
            <td colspan="7" class="muted">No payment records yet.</td>
          </tr>
        <% } %>
        <% payments.forEach((payment) => { %>
          <tr>
            <td><%= payment.createdAt %></td>
            <td><%= payment.transactionType %></td>
            <td><%= payment.transactionRef %></td>
            <td><%= payment.paymentProvider || "-" %></td>
            <td><%= formatNaira(payment.grossAmount) %></td>
            <td><%= formatNaira(payment.hotelPayout) %></td>
            <td><%= formatNaira(payment.platformEarning) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Smart Pricing Insights (last 30 days)</h2>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Room Category</th>
          <th>Base Price</th>
          <th>Occupancy</th>
          <th>Booked Nights</th>
          <th>Recommendation</th>
        </tr>
      </thead>
      <tbody>
        <% pricingInsights.forEach((insight) => { %>
          <tr>
            <td><%= insight.category %></td>
            <td><%= formatNaira(insight.basePrice) %></td>
            <td><%= Math.round(insight.occupancyRate * 100) %>%</td>
            <td><%= insight.bookedNights %></td>
            <td><%= insight.recommendation %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>

<%- include("partials/footer", { platform }) %>
