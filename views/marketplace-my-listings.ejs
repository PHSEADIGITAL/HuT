<%- include("partials/header", { title: "My Marketplace Listings" }) %>
<%- include("partials/marketplace-masthead", {
  categories,
  searchQuery: "",
  searchCategory: ""
}) %>

<section class="card marketplace-page-intro">
  <h1>My marketplace listings</h1>
  <p>Manage your active and sold items from one seller dashboard.</p>
</section>

<section class="marketplace-ebay-layout marketplace-manage-layout">
  <aside class="card marketplace-sticky-card">
    <h3>Seller summary</h3>
    <p class="muted tiny">Used this month</p>
    <p class="metric"><%= limitState.used %> / <%= limitState.includedLimit %></p>
    <p class="muted tiny">Remaining: <strong><%= limitState.remaining %></strong></p>
    <p class="muted tiny">Total listings: <strong><%= listings.length %></strong></p>
    <p class="muted tiny">Wallet: <strong><%= formatNaira(walletBalance || 0) %></strong></p>
    <p class="muted tiny">Points: <strong><%= marketplacePoints || 0 %></strong></p>
    <p class="muted tiny">Paid unlocks: <strong><%= marketplacePaidUnlockCount || 0 %></strong></p>

    <div class="marketplace-actions">
      <a class="button-link full-width" href="/marketplace/new">Create listing</a>
      <a class="ghost-link" href="/marketplace">Browse marketplace</a>
    </div>

    <hr />

    <h3>Upgrade listing limit</h3>
    <% if (activePlanSubscriptions.length) { %>
      <p class="muted tiny">Active plans: <%= activePlanSubscriptions.map((item) => item.planName).join(", ") %></p>
    <% } %>
    <div class="marketplace-plan-grid">
      <% marketplacePlans.forEach((plan) => { %>
        <article class="card">
          <h4><%= plan.name %></h4>
          <p class="market-price"><%= formatNaira(plan.amount) %></p>
          <p class="muted tiny"><%= plan.description %></p>
          <p class="muted tiny">Adds <%= plan.extraListings %> listings/month</p>
          <form method="POST" action="/marketplace/plans/purchase">
            <input type="hidden" name="planId" value="<%= plan.id %>" />
            <button type="submit" class="ghost-btn">Buy with wallet</button>
          </form>
        </article>
      <% }) %>
    </div>
  </aside>

  <section class="marketplace-result-list">
    <% if (!listings.length) { %>
      <article class="card">
        <p class="muted">You have not listed any item yet.</p>
      </article>
    <% } %>
    <% listings.forEach((listing) => { %>
      <article class="market-result-card">
        <a class="market-result-media" href="/marketplace/listings/<%= listing.id %>">
          <img src="<%= listing.primaryImage %>" alt="<%= listing.title %>" />
        </a>
        <div class="market-result-main">
          <h3><a href="/marketplace/listings/<%= listing.id %>"><%= listing.title %></a></h3>
          <p class="muted tiny"><%= listing.category %> • <%= listing.condition %></p>
          <p class="muted tiny">
            <%= listing.location || "Location not set" %>
            <% if (listing.neighborhood) { %>• <%= listing.neighborhood %><% } %>
          </p>
          <p class="muted tiny">Status: <strong><%= listing.status %></strong></p>
        </div>
        <div class="market-result-side">
          <p class="price-anchor muted tiny">
            Anchor price: <span class="anchor-original"><%= formatNaira(calculateAnchoredPrice(listing.price, 0.12)) %></span>
          </p>
          <p class="market-price"><%= formatNaira(listing.price) %></p>
          <% if (listing.status === "active") { %>
            <form method="POST" action="/marketplace/listings/<%= listing.id %>/mark-sold">
              <button type="submit" class="ghost-btn full-width">Mark as sold</button>
            </form>
          <% } %>
        </div>
      </article>
    <% }) %>
  </section>
</section>

<%- include("partials/footer", { platform }) %>
