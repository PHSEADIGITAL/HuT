<%
  const queryValue = typeof searchQuery === "string" ? searchQuery : "";
  const selectedCategory = typeof searchCategory === "string" ? searchCategory : "";
  const selectedLocation = typeof searchLocation === "string" ? searchLocation : "";
  const selectedNeighborhood = typeof searchNeighborhood === "string" ? searchNeighborhood : "";
  const categoryOptions = Array.isArray(categories) ? categories : [];
  const quickCategories = categoryOptions.slice(0, 10);
  const buildCategoryHref = (categoryName = "") => {
    const params = new URLSearchParams();
    if (queryValue) {
      params.set("q", queryValue);
    }
    if (categoryName) {
      params.set("category", categoryName);
    }
    if (selectedLocation) {
      params.set("location", selectedLocation);
    }
    if (selectedNeighborhood) {
      params.set("neighborhood", selectedNeighborhood);
    }
    return `/marketplace${params.toString() ? `?${params.toString()}` : ""}`;
  };
%>

<section class="marketplace-hub">
  <div class="marketplace-util-bar">
    <p class="muted tiny">
      <% if (currentUser) { %>
        Welcome back, <strong><%= currentUser.name %></strong>
      <% } else { %>
        Welcome to Hut Marketplace
      <% } %>
    </p>
    <div class="marketplace-util-links tiny">
      <a href="/marketplace">Home</a>
      <% if (currentUser) { %>
        <a href="/marketplace/my-listings">My Listings</a>
        <a href="/marketplace/new">Sell Item</a>
        <a href="/wallet">Wallet</a>
      <% } else { %>
        <a href="/auth/login?next=%2Fmarketplace">Sign in</a>
        <a href="/auth/register?next=%2Fmarketplace">Register</a>
      <% } %>
    </div>
    <div class="history-nav">
      <button type="button" class="ghost-btn tiny js-history-back">Back</button>
      <button type="button" class="ghost-btn tiny js-history-forward">Forward</button>
    </div>
  </div>

  <form class="marketplace-global-search" method="GET" action="/marketplace">
    <% if (selectedLocation) { %>
      <input type="hidden" name="location" value="<%= selectedLocation %>" />
    <% } %>
    <% if (selectedNeighborhood) { %>
      <input type="hidden" name="neighborhood" value="<%= selectedNeighborhood %>" />
    <% } %>
    <div class="marketplace-search-input-wrap">
      <input
        type="text"
        name="q"
        value="<%= queryValue %>"
        placeholder="Search for anything"
        aria-label="Search marketplace items"
      />
    </div>
    <div class="marketplace-search-category-wrap">
      <select name="category" aria-label="Select category">
        <option value="">All Categories</option>
        <% categoryOptions.forEach((categoryName) => { %>
          <option
            value="<%= categoryName %>"
            <%= selectedCategory === categoryName ? "selected" : "" %>
          >
            <%= categoryName %>
          </option>
        <% }) %>
      </select>
    </div>
    <button type="submit" class="marketplace-search-btn">Search</button>
  </form>

  <nav class="marketplace-quick-nav">
    <a class="<%= !selectedCategory ? "active" : "" %>" href="<%= buildCategoryHref("") %>">All</a>
    <% quickCategories.forEach((categoryName) => { %>
      <a
        class="<%= selectedCategory === categoryName ? "active" : "" %>"
        href="<%= buildCategoryHref(categoryName) %>"
      >
        <%= categoryName %>
      </a>
    <% }) %>
  </nav>
</section>
