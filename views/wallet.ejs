<%- include("partials/header", { title: "My Wallet" }) %>

<section class="hero small">
  <h1>Virtual Wallet</h1>
  <p>Fund your wallet and use it for marketplace contact unlocks.</p>
</section>

<section class="stats-grid">
  <article class="card">
    <h3>Current Balance</h3>
    <p class="metric"><%= formatNaira(walletUser.walletBalance || 0) %></p>
  </article>
  <article class="card">
    <h3>Unlock Fee</h3>
    <p class="metric"><%= formatNaira(contactUnlockFeeNaira) %></p>
  </article>
  <article class="card">
    <h3>Total Unlocks</h3>
    <p class="metric"><%= unlocks.length %></p>
  </article>
  <article class="card">
    <h3>Marketplace Points</h3>
    <p class="metric"><%= marketplacePoints || 0 %></p>
    <p class="muted tiny">5 points can unlock 1 seller contact.</p>
  </article>
  <article class="card">
    <h3>Paid Unlock Count</h3>
    <p class="metric"><%= marketplacePaidUnlockCount || 0 %></p>
    <p class="muted tiny">Earn 5 points every 5 paid unlocks.</p>
  </article>
</section>

<section class="card">
  <h2>Fund wallet</h2>
  <% if (canTopUp) { %>
    <p class="muted">
      Top-ups use secure checkout and are credited only after verified provider webhook confirmation.
      Funds are collected through <strong><%= collectionAccountAlias %></strong>.
    </p>
    <form class="grid-form compact" method="POST" action="/wallet/topup">
      <div>
        <label for="amount">Amount (NGN)</label>
        <input id="amount" name="amount" type="number" min="1" required />
      </div>
      <input type="hidden" name="reference" value="" />
      <div class="align-end">
        <button type="submit">Fund wallet securely</button>
      </div>
    </form>
    <p class="muted tiny">Payment provider: <strong><%= paymentProvider %></strong></p>
  <% } else { %>
    <p class="muted">
      Wallet top-up is disabled for hotel admin accounts.
    </p>
  <% } %>
</section>

<section class="card">
  <h2>Pending top-ups</h2>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Created</th>
          <th>Provider</th>
          <th>Reference</th>
          <th>Amount</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% if (!pendingTopups.length) { %>
          <tr><td colspan="5" class="muted">No pending top-ups.</td></tr>
        <% } %>
        <% pendingTopups.forEach((intent) => { %>
          <tr>
            <td><%= intent.createdAt %></td>
            <td><%= intent.provider %></td>
            <td><%= intent.reference %></td>
            <td><%= formatNaira(intent.amount) %></td>
            <td><%= intent.status %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Wallet transactions</h2>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Description</th>
          <th>Reference</th>
          <th>Amount</th>
          <th>Balance After</th>
        </tr>
      </thead>
      <tbody>
        <% if (!walletTransactions.length) { %>
          <tr><td colspan="6" class="muted">No wallet transactions yet.</td></tr>
        <% } %>
        <% walletTransactions.forEach((entry) => { %>
          <tr>
            <td><%= entry.createdAt %></td>
            <td><%= entry.type %></td>
            <td><%= entry.description %></td>
            <td><%= entry.reference %></td>
            <td class="<%= entry.direction === 'debit' ? 'danger' : 'success' %>">
              <%= entry.direction === "debit" ? "-" : "+" %><%= formatNaira(entry.amount) %>
            </td>
            <td><%= formatNaira(entry.balanceAfter) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>

<%- include("partials/footer", { platform }) %>
